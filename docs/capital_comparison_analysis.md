# 금융사별 엑셀 구조 비교 분석

## 1. 전체 비교표

| 항목 | 메리츠캐피탈 | NH농협캐피탈 | MG캐피탈 |
|------|-------------|------------|----------|
| **파일명** | meritz_capital_2509_V1.xlsx | nh_capital_2510_V2.xlsx | mg_capital_2510_vol3.xlsx |
| **차량 수** | 1,145대 | 788대 | 655대 |
| **주요 시트 수** | 18개 | 6개 | 15개 |
| **차량 정보 시트** | "차종" (14번) | "차량정보(리스)" (5번) | "차량DB" (8번) |
| **잔가 테이블 시트** | "잔가" (16번) | "리스수식" (4번) | 차량DB 내 포함 추정 |
| **잔가 관리 방식** | 등급별 마스터 테이블 | 직접 테이블 | 미확인 (추가 분석 필요) |

---

## 2. 메리츠캐피탈 상세 분석

### 2.1 구조 특징
- **등급 기반 시스템**: 각 차량에 잔가 등급(West, APS, VGS, J 등)이 할당
- **캐피탈사별 테이블**: 여러 캐피탈사(West, APS, VGS, J)의 잔가 테이블을 보유
- **주행거리 조정**: 기본 잔가 + 주행거리별 조정값 방식

### 2.2 시트 구조
1. **차종 시트** (1,145행 × 697열)
   - 위치: Row 6 헤더, Row 7부터 데이터
   - 주요 컬럼:
     - 컬럼 2: Maker (제조사)
     - 컬럼 3: Model1 (모델명)
     - 컬럼 5: Model3 (세부 모델명)
     - 컬럼 6: 차량가격(원)
     - 컬럼 7: 배기량(cc)
     - 컬럼 8: 유종 (가솔린/디젤/전기)
     - 컬럼 10: **웨스트 등급** (B, C, D, E, F, G, H, I 등)
     - 컬럼 12: **APS 등급** (K, L, M, T 등)

2. **잔가 시트** (77행 × 23열)
   - **West 테이블** (Row 48-53):
     ```
     기간/등급  W     S     A     B     C     D     E     F     G     H     I
     12        0.70  0.68  0.66  0.64  0.62  0.60  0.58  0.56  0.54  0.51
     24        0.62  0.60  0.58  0.56  0.54  0.52  0.50  0.48  0.46  0.43
     36        0.54  0.52  0.50  0.48  0.46  0.44  0.42  0.40  0.38  0.35
     48        0.46  0.44  0.42  0.40  0.38  0.36  0.34  0.32  0.30  0.27
     60        0.40  0.38  0.36  0.34  0.32  0.30  0.28  0.26  0.24  0.20
     ```

   - **J 테이블** (Row 57-62): 더 많은 등급 (S1~S5, A~O)
   - **APS 테이블** (Row 65-70): (SA1, SA, A1, A~X)
   - **VGS 테이블** (Row 73-77): (S+, S, A+, AA, A, B, C, D)

   - **주행거리 조정값** (Row 36-39):
     ```
     주행거리    조정값
     10,000     0.00
     15,000     0.00
     20,000     0.00
     30,000    -0.04
     ```

### 2.3 잔존율 계산 로직
```python
# 예시: BMW X7 (West 등급 H, 36개월, 20,000km)
기본잔가 = West테이블[36][H] = 0.38
주행거리조정 = 조정테이블[20000] = 0.00
최종잔가 = 0.38 + 0.00 = 0.38 (38%)
```

---

## 3. NH농협캐피탈 상세 분석

### 3.1 구조 특징
- **단순화된 구조**: 6개 시트로 구성
- **차량별 등급 표시**: 차량정보 시트에 C/B/A 등급 표시
- **리스수식 시트**: 잔가 계산 로직 및 테이블 포함

### 3.2 시트 구조
1. **차량정보(리스) 시트** (788행 × 38열)
   - Row 6부터 데이터
   - 주요 컬럼:
     - 컬럼 12: 제조사
     - 컬럼 13: 차종
     - 컬럼 14: 모델
     - 컬럼 15: 가격
     - 컬럼 16: 종류 (승용RV 등)
     - 컬럼 20: 배기량
     - 컬럼 21: 차세
     - 컬럼 22: **C 등급**
     - 컬럼 23: **B 등급**
     - 컬럼 24: **자체(A) 등급**

2. **리스수식 시트** (90행 × 57열)
   - Row 3-4에서 잔존율 패턴 발견:
     ```
     Row 4: 0.73, 0.64, 0.56, 0.50, 0.62, 0.54, 0.46, 0.37
     Row 5: 0.72, 0.63, 0.55, 0.49, 0.61, 0.53, 0.45, 0.36
     ```
   - 계약기간 패턴 발견: Row 3, 31, 55, 57에 24, 36, 48, 60

### 3.3 특이사항
- 등급별로 컬럼이 구분되어 있음 (C, B, A)
- 잔가 계산 로직이 수식으로 복잡하게 구현
- 차량 수가 3사 중 중간 (788대)

---

## 4. MG캐피탈 상세 분석

### 4.1 구조 특징
- **간결한 DB 구조**: "차량DB" 시트에 정보 집중
- **멀티 상품**: 운용리스, 금융리스, 할부오토론 별도 시트

### 4.2 시트 구조
1. **차량DB 시트** (655행 × 38열)
   - Row 5 헤더
   - Row 6부터 데이터
   - 주요 컬럼:
     - 컬럼 4: SEQ
     - 컬럼 5: BRAND
     - 컬럼 6: MODEL
     - 컬럼 7: 배기량
     - 컬럼 8: 차종분류
     - 컬럼 9: 차량가
     - 컬럼 10~: 잔가 데이터로 추정 (추가 분석 필요)

2. **견적관리자용 시트**
   - IRR 설정 테이블 포함
   - 브랜드별 IRR 관리 (BENZ: 0.048, BMW: 0.048 등)

### 4.3 특이사항
- 차량 수가 3사 중 가장 적음 (655대)
- Row 1에 "2.5만km/연" 표시 → 주행거리 기준 추정
- 펀딩신청서, 유입경로확인서 등 업무 프로세스 시트 포함

---

## 5. 공통점과 차이점 정리

### 5.1 공통점
1. ✅ 모두 차량 마스터 데이터를 별도 시트로 관리
2. ✅ 제조사, 모델명, 차량가, 배기량 등 기본 정보 보유
3. ✅ 견적 계산용 별도 시트 존재 (운용리스, 금융리스 등)
4. ✅ 계약기간: 24, 36, 48, 60개월 지원
5. ✅ 주행거리: 15,000, 20,000, 30,000km 기준

### 5.2 차이점

| 구분 | 메리츠캐피탈 | NH농협캐피탈 | MG캐피탈 |
|------|-------------|------------|----------|
| **잔가 관리 방식** | 등급 → 마스터 테이블 조회 | 차량별 직접 등급 표시 | 차량별 직접 포함 추정 |
| **복잡도** | ⭐⭐⭐ (높음) | ⭐⭐ (중간) | ⭐ (낮음) |
| **캐피탈사 수** | 4개 (West, J, APS, VGS) | 1개 (자체) | 1개 (자체) |
| **주행거리 조정** | 별도 조정 테이블 | 등급 내 포함 추정 | 미확인 |
| **데이터 무결성** | 참조 방식 (일관성 ↑) | 직접 입력 (유연성 ↑) | 단순 (유지보수 ↑) |

---

## 6. 추출 전략 수립

### 6.1 메리츠캐피탈 추출 전략
**✅ 이미 구현 준비 완료**

```python
# 1단계: 차종 시트에서 차량 정보 + 등급 추출
vehicle_data = {
    "brand": row[1],      # Maker
    "model": row[4],      # Model3
    "price": row[5],      # 차량가격
    "west_grade": row[9], # 웨스트 등급
    "aps_grade": row[11]  # APS 등급
}

# 2단계: 잔가 시트에서 등급별 테이블 추출
west_table = parse_residual_table(row=49-54, col=3-13)
aps_table = parse_residual_table(row=66-71, col=3-23)

# 3단계: 주행거리 조정값 추출
mileage_adj = {
    10000: 0.00,
    15000: 0.00,
    20000: 0.00,
    30000: -0.04
}

# 4단계: 차량별 잔존율 계산
for period in [24, 36, 48, 60]:
    for mileage in [10000, 15000, 20000, 30000]:
        base_rate = west_table[period][vehicle.grade]
        adjustment = mileage_adj[mileage]
        final_rate = base_rate + adjustment
        residual_rates[vehicle_id][period][mileage] = final_rate
```

### 6.2 NH농협캐피탈 추출 전략
**🔍 추가 분석 필요**

```python
# 1단계: 차량정보(리스) 시트에서 기본 정보 추출
vehicle_data = {
    "brand": row[12],
    "model": row[14],
    "price": row[15],
    "c_grade": row[22],  # C 등급 번호
    "b_grade": row[23],  # B 등급 번호
    "a_grade": row[24]   # A 등급 번호
}

# 2단계: 리스수식 시트 정밀 분석 필요
# - Row 3, 31, 55, 57에 기간 패턴 존재
# - 등급별 잔가 테이블 위치 식별 필요
# - 주행거리 조정 방식 확인 필요

# TODO: 리스수식 시트 상세 분석
```

### 6.3 MG캐피탈 추출 전략
**🔍 추가 분석 필요**

```python
# 1단계: 차량DB 시트에서 기본 정보 추출
vehicle_data = {
    "seq": row[3],
    "brand": row[4],
    "model": row[5],
    "engine_cc": row[6],
    "vehicle_type": row[7],
    "price": row[8]
}

# 2단계: 컬럼 10 이후 데이터 분석 필요
# - 잔가 데이터로 추정되나 구조 미확인
# - Row 1에 "2.5만km/연" 표시 → 주행거리 기준?
# - 컬럼 매핑 필요

# TODO: 차량DB 시트 잔가 컬럼 정밀 분석
```

---

## 7. 구현 우선순위

### Phase 1: 메리츠캐피탈 (즉시 시작 가능)
- ✅ 구조 분석 완료
- ✅ 추출 로직 설계 완료
- ⏳ 구현 대기 중

**예상 작업량**: 2-3시간
- meritz_extractor.py 완성
- 1,145대 차량 → JSON 변환
- 검증 및 테스트

### Phase 2: NH농협캐피탈 (분석 필요)
- 🔍 리스수식 시트 정밀 분석 (1-2시간)
- ⏳ 추출 로직 개발 (2-3시간)
- ⏳ 788대 차량 → JSON 변환

**블로커**: 리스수식 시트의 잔가 테이블 구조 파악 필요

### Phase 3: MG캐피탈 (분석 필요)
- 🔍 차량DB 시트 잔가 컬럼 분석 (1-2시간)
- ⏳ 추출 로직 개발 (2-3시간)
- ⏳ 655대 차량 → JSON 변환

**블로커**: 차량DB 시트의 잔가 데이터 위치 및 형식 파악 필요

---

## 8. 다음 액션 아이템

### 즉시 실행 가능
1. ✅ **메리츠캐피탈 추출기 완성 및 실행**
   - `meritz_extractor.py` 완성
   - 실행 및 JSON 생성
   - vehicle_master.json 및 meritz_capital.json 검증

### 병렬 작업 (분석 필요)
2. 🔍 **NH농협캐피탈 리스수식 시트 정밀 분석**
   - Row 3, 31, 55, 57 주변 데이터 구조 파악
   - 등급(C/B/A)별 잔가 테이블 위치 식별
   - 주행거리 조정 방식 확인

3. 🔍 **MG캐피탈 차량DB 시트 잔가 컬럼 분석**
   - 컬럼 10 이후 데이터 의미 파악
   - 기간별/주행거리별 매핑 확인
   - 견적관리자용 시트와의 연관성 분석

### 후속 작업
4. ⏳ **공통 데이터 로더 개발**
   - `data/residual_rates.py` 구현
   - 다중 캐피탈 데이터 통합 로딩

5. ⏳ **계산 엔진 개발**
   - `core/calculator.py` 구현
   - 캐피탈별 금리 정책 적용

6. ⏳ **Streamlit UI 개발**
   - 캐피탈 선택 → 차량 선택 → 조건 입력 → 결과 표시
