# ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚°ê¸° v2 ê°œë°œëª…ì„¸ì„œ

## 1. í”„ë¡œì íŠ¸ ê°œìš”

### 1.1 ëª©ì 
íŠ¹ì • ê¸ˆìœµì‚¬ì˜ ì—‘ì…€ ê²¬ì ê¸°ë¥¼ **ì—­ê³µí•™(Reverse Engineering)**í•˜ì—¬ ë™ì¼í•œ ê³„ì‚° ê²°ê³¼ë¥¼ ë„ì¶œí•˜ëŠ” ì›¹ ê¸°ë°˜ ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚°ê¸° ê°œë°œ

### 1.2 ëª©í‘œ
- ê¸ˆìœµì‚¬ ì—‘ì…€ ê²¬ì ì„œì™€ **ì˜¤ì°¨ Â±2,000ì› ì´ë‚´** ì •í™•ë„ ë‹¬ì„±
- ê³ ê° ì…ë ¥ ìµœì†Œí™” (ì°¨ëŸ‰, ê¸°ê°„, ì£¼í–‰ê±°ë¦¬, ë³´ì¦ê¸ˆë§Œ ì…ë ¥)
- ì‹¤ì‹œê°„ ê³„ì‚° ë° ê²°ê³¼ í‘œì‹œ
- ë‹¤ì¤‘ ê¸ˆìœµì‚¬ ë¹„êµ ê¸°ëŠ¥ (í™•ì¥ ê°€ëŠ¥ êµ¬ì¡°)

### 1.3 ê¸°ìˆ  ìŠ¤íƒ
```
Backend:  Python 3.10+
Frontend: Streamlit
Data:     JSON íŒŒì¼ (ì°¨ëŸ‰ë³„ ì”ì¡´ìœ¨ 3,000~4,000ëŒ€ ê´€ë¦¬)
Tools:    pandas, numpy, openpyxl (ì—‘ì…€ íŒŒì‹±)
```

### 1.4 ê°œë°œ ë‹¨ê³„
- **Phase 1 (MVP):** ë‹¨ì¼ ê¸ˆìœµì‚¬ ì—‘ì…€ íŒŒì¼ ë¶„ì„ ë° ì—­ê³µí•™
- **Phase 2:** ì”ì¡´ìœ¨ ë°ì´í„° JSON êµ¬ì¶• ë° ê³„ì‚°ê¸° ê°œë°œ
- **Phase 3:** Streamlit í”„ë¡œí† íƒ€ì… ê°œë°œ
- **Phase 4:** ë‹¤ì¤‘ ê¸ˆìœµì‚¬ ë¹„êµ ê¸°ëŠ¥
- **Phase 5:** ê²Ÿì°¨ í”Œë«í¼ í†µí•©

---

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 2.1 ì „ì²´ êµ¬ì¡°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Streamlit Frontend              â”‚
â”‚  (ê³ ê° ì…ë ¥ UI + ê²°ê³¼ í‘œì‹œ)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Calculation Engine (Core)          â”‚
â”‚  - calculate_operating_lease()          â”‚
â”‚  - ì •ì•¡ë²•/ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜ ì§€ì›            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Data Layer (JSON)                â”‚
â”‚  - ì°¨ëŸ‰ ë§ˆìŠ¤í„° ë°ì´í„°                    â”‚
â”‚  - ì”ì¡´ìœ¨ í…Œì´ë¸” (3,000~4,000ëŒ€)        â”‚
â”‚  - ê¸ˆë¦¬ í…Œì´ë¸”                           â”‚
â”‚  - ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ ì •ì±…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Excel Reverse Engineering          â”‚
â”‚  - ì—‘ì…€ íŒŒì¼ íŒŒì‹±                        â”‚
â”‚  - ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ                    â”‚
â”‚  - íŒŒë¼ë¯¸í„° ì—­ì‚°                         â”‚
â”‚  - JSON ë³€í™˜ ìë™í™”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
lease-calculator-v2/
â”œâ”€â”€ app.py                          # Streamlit ë©”ì¸ ì•±
â”œâ”€â”€ requirements.txt                # íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ calculator.py               # ê³„ì‚° ì—”ì§„
â”‚   â”œâ”€â”€ validator.py                # ì…ë ¥ ê²€ì¦
â”‚   â””â”€â”€ irr_validator.py            # IRR ê²€ì¦ ë„êµ¬
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ vehicle_master.json         # ì°¨ëŸ‰ ë§ˆìŠ¤í„° (3,000~4,000ëŒ€)
â”‚   â”œâ”€â”€ residual_rates/             # ìºí”¼íƒˆë³„ ì”ì¡´ìœ¨ JSON
â”‚   â”‚   â”œâ”€â”€ meritz_capital.json    # ë©”ë¦¬ì¸ ìºí”¼íƒˆ (ì˜ˆì‹œ)
â”‚   â”‚   â”œâ”€â”€ im_capital.json         # iMìºí”¼íƒˆ (ì˜ˆì‹œ)
â”‚   â”‚   â””â”€â”€ nh_capital.json       # NHë†í˜‘ìºí”¼íƒˆ (ì˜ˆì‹œ)
â”‚   â”œâ”€â”€ vehicle_master.py           # ì°¨ëŸ‰ ë°ì´í„° ë¡œë”
â”‚   â”œâ”€â”€ residual_rates.py           # ì”ì¡´ìœ¨ ë¡œë”
â”‚   â”œâ”€â”€ interest_rates.py           # ê¸ˆë¦¬ í…Œì´ë¸”
â”‚   â””â”€â”€ tax_policies.py             # ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ ì •ì±…
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ data_loader.py              # JSON ë¡œë” ìœ í‹¸
â”‚   â””â”€â”€ formatters.py               # ì¶œë ¥ í¬ë§·íŒ…
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_calculator.py          # ê³„ì‚° ë¡œì§ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ test_integration.py         # í†µí•© í…ŒìŠ¤íŠ¸
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ excel_to_json.py            # ì—‘ì…€ â†’ JSON ë³€í™˜ ë„êµ¬
â”‚   â””â”€â”€ validate_json.py            # JSON ë°ì´í„° ê²€ì¦
â”‚
â””â”€â”€ excel_reverse_engineering/
    â”œâ”€â”€ excel_parser.py             # ì—‘ì…€ íŒŒì¼ íŒŒì‹±
    â”œâ”€â”€ residual_extractor.py       # ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ
    â”œâ”€â”€ formula_extractor.py        # ì—‘ì…€ ìˆ˜ì‹ ì¶”ì¶œ
    â”œâ”€â”€ parameter_finder.py         # íŒŒë¼ë¯¸í„° ì—­ì‚°
    â””â”€â”€ validation_report.py        # ê²€ì¦ ë¦¬í¬íŠ¸ ìƒì„±
```

---

## 3. ë°ì´í„° êµ¬ì¡° ì„¤ê³„ (JSON ê¸°ë°˜)

### 3.1 í•µì‹¬ ì„¤ê³„ ì›ì¹™

**ì”ì¡´ìœ¨ì€ ë¡œì§ì´ ì•„ë‹Œ ë°ì´í„°ë¡œ ê´€ë¦¬**
- ì”ì¡´ìœ¨ 2%p ì°¨ì´ = ì›” ë¦¬ìŠ¤ë£Œ ì•½ 28,000ì› ì°¨ì´ (5ì²œë§Œì› ì°¨ëŸ‰ ê¸°ì¤€)
- ì”ì¡´ìœ¨ì€ ì¤‘ê³ ì°¨ ì‹œì„¸ ì˜ˆì¸¡ê°’ìœ¼ë¡œ, ê³µì‹ ê³„ì‚° ë¶ˆê°€ëŠ¥
- ìºí”¼íƒˆë³„ Ã— ì°¨ëŸ‰ë³„ Ã— ê¸°ê°„ë³„ Ã— ì£¼í–‰ê±°ë¦¬ë³„ = ì™„ì „í•œ ë°ì´í„°ë² ì´ìŠ¤í™” í•„ìš”

**ë°ì´í„° ê·œëª¨**
```
ì°¨ëŸ‰ 1ëŒ€ = 4ê°œ ê¸°ê°„ Ã— 4ê°œ ì£¼í–‰ê±°ë¦¬ = 16ê°œ ê°’
4,000ëŒ€ Ã— 16ê°œ = 64,000ê°œ ìˆ«ì
â†’ ë©”ëª¨ë¦¬: 0.5MB / ë””ìŠ¤í¬: 2~3MB (JSON)
â†’ ì¡°íšŒ ì†ë„: < 1ms (ì™„ì „íˆ ë¬´ì‹œ ê°€ëŠ¥)
```

---

### 3.2 ì°¨ëŸ‰ ë§ˆìŠ¤í„° ë°ì´í„° (JSON)

**íŒŒì¼: `data/vehicle_master.json`**

```json
{
  "K5_2024_2.0_PRESTIGE": {
    "brand": "ê¸°ì•„",
    "model": "K5",
    "year": 2024,
    "trim": "2.0 í”„ë ˆìŠ¤í‹°ì§€",
    "display_name": "ê¸°ì•„ K5 2.0 í”„ë ˆìŠ¤í‹°ì§€",
    "price": 32500000,
    "engine_cc": 1999,
    "fuel_type": "gasoline",
    "vehicle_type": "sedan",
    "is_ev": false,
    "is_import": false,
    "manufacturer": "í˜„ëŒ€ìë™ì°¨ê·¸ë£¹",
    "updated_at": "2025-01-15"
  },
  "SONATA_2024_1.6T_SIGNATURE": {
    "brand": "í˜„ëŒ€",
    "model": "ì˜ë‚˜íƒ€",
    "year": 2024,
    "trim": "1.6 í„°ë³´ ì‹œê·¸ë‹ˆì²˜",
    "display_name": "í˜„ëŒ€ ì˜ë‚˜íƒ€ 1.6 í„°ë³´ ì‹œê·¸ë‹ˆì²˜",
    "price": 35800000,
    "engine_cc": 1598,
    "fuel_type": "gasoline",
    "vehicle_type": "sedan",
    "is_ev": false,
    "is_import": false,
    "manufacturer": "í˜„ëŒ€ìë™ì°¨ê·¸ë£¹",
    "updated_at": "2025-01-15"
  }
  // ... 3,000~4,000ëŒ€
}
```

**ë¡œë”: `data/vehicle_master.py`**

```python
"""
data/vehicle_master.py
ì°¨ëŸ‰ ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë”
"""

import json
from pathlib import Path
from typing import Dict, List, Optional

# ì‹±ê¸€í†¤ ìºì‹œ
_VEHICLE_CACHE: Optional[Dict] = None

def _load_vehicles() -> Dict:
    """ì°¨ëŸ‰ ë°ì´í„° ë¡œë“œ (ìºì‹±)"""
    global _VEHICLE_CACHE
    
    if _VEHICLE_CACHE is None:
        json_path = Path(__file__).parent / "vehicle_master.json"
        with open(json_path, 'r', encoding='utf-8') as f:
            _VEHICLE_CACHE = json.load(f)
    
    return _VEHICLE_CACHE


def get_vehicle(vehicle_id: str) -> Dict:
    """ì°¨ëŸ‰ ìƒì„¸ ì •ë³´ ì¡°íšŒ"""
    vehicles = _load_vehicles()
    
    if vehicle_id not in vehicles:
        raise ValueError(f"ì°¨ëŸ‰ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {vehicle_id}")
    
    return vehicles[vehicle_id]


def get_vehicle_list(brand: Optional[str] = None, 
                     vehicle_type: Optional[str] = None) -> List[Dict]:
    """
    ì°¨ëŸ‰ ëª©ë¡ ì¡°íšŒ (í•„í„°ë§ ê°€ëŠ¥)
    
    Parameters:
        brand: ë¸Œëœë“œ í•„í„° (ì˜ˆ: "ê¸°ì•„", "í˜„ëŒ€")
        vehicle_type: ì°¨ì¢… í•„í„° (ì˜ˆ: "sedan", "suv")
    
    Returns:
        List[Dict]: ì°¨ëŸ‰ ëª©ë¡ [{"id": ..., "display": ..., "price": ...}, ...]
    """
    vehicles = _load_vehicles()
    
    result = []
    for vehicle_id, vehicle_data in vehicles.items():
        # í•„í„° ì ìš©
        if brand and vehicle_data["brand"] != brand:
            continue
        if vehicle_type and vehicle_data["vehicle_type"] != vehicle_type:
            continue
        
        result.append({
            "id": vehicle_id,
            "display": vehicle_data["display_name"],
            "brand": vehicle_data["brand"],
            "price": vehicle_data["price"]
        })
    
    return result


def get_all_vehicle_ids() -> List[str]:
    """ì „ì²´ ì°¨ëŸ‰ ID ëª©ë¡"""
    vehicles = _load_vehicles()
    return list(vehicles.keys())


def validate_vehicle_exists(vehicle_id: str) -> bool:
    """ì°¨ëŸ‰ ì¡´ì¬ ì—¬ë¶€ í™•ì¸"""
    vehicles = _load_vehicles()
    return vehicle_id in vehicles
```

---

### 3.3 ì”ì¡´ìœ¨ ë°ì´í„° (JSON - ìºí”¼íƒˆë³„)

**íŒŒì¼: `data/residual_rates/meritz_capital.json`**

```json
{
  "K5_2024_2.0_PRESTIGE": {
    "24": {
      "10000": 0.65,
      "15000": 0.63,
      "20000": 0.62,
      "30000": 0.59
    },
    "36": {
      "10000": 0.53,
      "15000": 0.51,
      "20000": 0.50,
      "30000": 0.47
    },
    "48": {
      "10000": 0.43,
      "15000": 0.41,
      "20000": 0.40,
      "30000": 0.37
    },
    "60": {
      "10000": 0.33,
      "15000": 0.31,
      "20000": 0.30,
      "30000": 0.27
    }
  },
  "SONATA_2024_1.6T_SIGNATURE": {
    "24": {
      "10000": 0.64,
      "15000": 0.62,
      "20000": 0.61,
      "30000": 0.58
    },
    "36": {
      "10000": 0.52,
      "15000": 0.50,
      "20000": 0.49,
      "30000": 0.46
    },
    "48": {
      "10000": 0.42,
      "15000": 0.40,
      "20000": 0.39,
      "30000": 0.36
    },
    "60": {
      "10000": 0.32,
      "15000": 0.30,
      "20000": 0.29,
      "30000": 0.26
    }
  }
  // ... 3,000~4,000ëŒ€ ì „ì²´
}
```

**ë¡œë”: `data/residual_rates.py`**

```python
"""
data/residual_rates.py
ì”ì¡´ìœ¨ ë°ì´í„° ë¡œë” (JSON ê¸°ë°˜)
"""

import json
from pathlib import Path
from typing import Dict, Optional

# ìºí”¼íƒˆë³„ ì”ì¡´ìœ¨ ìºì‹œ
_RESIDUAL_CACHE: Dict[str, Dict] = {}


def _load_residual_rates(capital_id: str) -> Dict:
    """
    ìºí”¼íƒˆë³„ ì”ì¡´ìœ¨ ë°ì´í„° ë¡œë“œ (ìºì‹±)
    
    Parameters:
        capital_id: ìºí”¼íƒˆ ID (ì˜ˆ: "meritz_capital", "im_capital")
    
    Returns:
        Dict: ì „ì²´ ì°¨ëŸ‰ì˜ ì”ì¡´ìœ¨ ë°ì´í„°
    """
    if capital_id not in _RESIDUAL_CACHE:
        json_path = Path(__file__).parent / "residual_rates" / f"{capital_id}.json"
        
        if not json_path.exists():
            raise FileNotFoundError(f"ì”ì¡´ìœ¨ ë°ì´í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {json_path}")
        
        with open(json_path, 'r', encoding='utf-8') as f:
            _RESIDUAL_CACHE[capital_id] = json.load(f)
    
    return _RESIDUAL_CACHE[capital_id]


def get_residual_rate(capital_id: str, vehicle_id: str, 
                      contract_months: int, annual_mileage: int) -> float:
    """
    ì”ì¡´ìœ¨ ì¡°íšŒ
    
    Parameters:
        capital_id: ìºí”¼íƒˆ ID
        vehicle_id: ì°¨ëŸ‰ ID
        contract_months: ê³„ì•½ ê¸°ê°„ (24, 36, 48, 60)
        annual_mileage: ì—°ê°„ ì£¼í–‰ê±°ë¦¬ (10000, 15000, 20000, 30000)
    
    Returns:
        float: ì”ì¡´ìœ¨ (0~1 ì‚¬ì´ ê°’)
    
    Raises:
        ValueError: ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
    """
    data = _load_residual_rates(capital_id)
    
    # JSONì€ í‚¤ê°€ ë¬¸ìì—´ì´ë¯€ë¡œ ë³€í™˜
    months_key = str(contract_months)
    mileage_key = str(annual_mileage)
    
    try:
        return data[vehicle_id][months_key][mileage_key]
    except KeyError as e:
        raise ValueError(
            f"ì”ì¡´ìœ¨ ë°ì´í„° ì—†ìŒ: {capital_id}/{vehicle_id}/{contract_months}/{annual_mileage}"
        ) from e


def get_vehicle_residual_table(capital_id: str, vehicle_id: str) -> Dict:
    """
    íŠ¹ì • ì°¨ëŸ‰ì˜ ì „ì²´ ì”ì¡´ìœ¨ í…Œì´ë¸” ì¡°íšŒ
    
    Parameters:
        capital_id: ìºí”¼íƒˆ ID
        vehicle_id: ì°¨ëŸ‰ ID
    
    Returns:
        Dict: {24: {10000: 0.65, ...}, 36: {...}, ...}
    """
    data = _load_residual_rates(capital_id)
    
    if vehicle_id not in data:
        raise ValueError(f"ì°¨ëŸ‰ {vehicle_id}ì˜ ì”ì¡´ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")
    
    # ë¬¸ìì—´ í‚¤ë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜
    result = {}
    for months_str, mileage_dict in data[vehicle_id].items():
        months = int(months_str)
        result[months] = {
            int(mileage_str): rate 
            for mileage_str, rate in mileage_dict.items()
        }
    
    return result


def get_all_vehicle_ids(capital_id: str) -> list:
    """ìºí”¼íƒˆì˜ ì „ì²´ ì°¨ëŸ‰ ëª©ë¡"""
    data = _load_residual_rates(capital_id)
    return list(data.keys())


def validate_vehicle_exists(capital_id: str, vehicle_id: str) -> bool:
    """ì°¨ëŸ‰ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸"""
    try:
        data = _load_residual_rates(capital_id)
        return vehicle_id in data
    except FileNotFoundError:
        return False


def get_available_capitals() -> list:
    """ì‚¬ìš© ê°€ëŠ¥í•œ ìºí”¼íƒˆ ëª©ë¡"""
    data_dir = Path(__file__).parent / "residual_rates"
    
    if not data_dir.exists():
        return []
    
    capitals = []
    for json_file in data_dir.glob("*.json"):
        capital_id = json_file.stem
        capitals.append(capital_id)
    
    return capitals
```

---

### 3.4 ê¸ˆë¦¬ ë°ì´í„° (Python Dict)

**íŒŒì¼: `data/interest_rates.py`**

```python
"""
data/interest_rates.py
ê¸ˆë¦¬ í…Œì´ë¸” (ì—‘ì…€ ì—­ì‚° ê²°ê³¼)
"""

# ìºí”¼íƒˆë³„ ê¸ˆë¦¬ êµ¬ì¡°
INTEREST_RATES = {
    "meritz_capital": {
        # ì°¨ëŸ‰ê°€ êµ¬ê°„ë³„ ê¸°ë³¸ ê¸ˆë¦¬
        "price_tiers": [
            {"max_price": 30_000_000, "rate": 0.065},  # 3ì²œë§Œì› ì´í•˜: 6.5%
            {"max_price": 50_000_000, "rate": 0.060},  # 5ì²œë§Œì› ì´í•˜: 6.0%
            {"max_price": float('inf'), "rate": 0.055} # 5ì²œë§Œì› ì´ˆê³¼: 5.5%
        ],
        
        # ê¸ˆë¦¬ ì¡°ì • ìš”ì†Œ
        "adjustments": {
            "domestic_brand": -0.005,   # í˜„ëŒ€/ê¸°ì•„ ìš°ëŒ€ -0.5%p
            "import_brand": 0.005,      # ìˆ˜ì…ì°¨ í• ì¦ +0.5%p
            "ev_vehicle": -0.003,       # ì „ê¸°ì°¨ ìš°ëŒ€ -0.3%p
            "long_term_48m": -0.002,    # 48ê°œì›” ì´ìƒ ìš°ëŒ€ -0.2%p
        }
    },
    
    "im_capital": {
        "price_tiers": [
            {"max_price": 30_000_000, "rate": 0.070},
            {"max_price": 50_000_000, "rate": 0.065},
            {"max_price": float('inf'), "rate": 0.060}
        ],
        "adjustments": {
            "domestic_brand": 0.000,
            "import_brand": 0.008,
            "ev_vehicle": -0.005,
            "long_term_48m": -0.002,
        }
    },
    
    "nh_capital": {
        "price_tiers": [
            {"max_price": 30_000_000, "rate": 0.068},
            {"max_price": 50_000_000, "rate": 0.063},
            {"max_price": float('inf'), "rate": 0.058}
        ],
        "adjustments": {
            "domestic_brand": -0.003,
            "import_brand": 0.006,
            "ev_vehicle": -0.004,
            "long_term_48m": -0.002,
        }
    }
}


def get_interest_rate(capital_id: str, vehicle_price: float, 
                      is_import: bool = False, is_ev: bool = False,
                      contract_months: int = 36) -> float:
    """
    ê¸ˆë¦¬ ì¡°íšŒ ë° ì¡°ì •
    
    Parameters:
        capital_id: ìºí”¼íƒˆ ID
        vehicle_price: ì°¨ëŸ‰ ê°€ê²©
        is_import: ìˆ˜ì…ì°¨ ì—¬ë¶€
        is_ev: ì „ê¸°ì°¨ ì—¬ë¶€
        contract_months: ê³„ì•½ ê¸°ê°„
    
    Returns:
        float: ìµœì¢… ì ìš© ê¸ˆë¦¬ (ì—°ìœ¨)
    """
    if capital_id not in INTEREST_RATES:
        raise ValueError(f"ìºí”¼íƒˆ {capital_id}ì˜ ê¸ˆë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")
    
    capital_data = INTEREST_RATES[capital_id]
    
    # 1. ì°¨ëŸ‰ê°€ ê¸°ì¤€ ê¸°ë³¸ ê¸ˆë¦¬
    base_rate = None
    for tier in capital_data["price_tiers"]:
        if vehicle_price <= tier["max_price"]:
            base_rate = tier["rate"]
            break
    
    if base_rate is None:
        base_rate = capital_data["price_tiers"][-1]["rate"]
    
    # 2. ì¡°ì • ì ìš©
    adjustments = capital_data["adjustments"]
    adjusted_rate = base_rate
    
    if is_import:
        adjusted_rate += adjustments["import_brand"]
    else:
        adjusted_rate += adjustments["domestic_brand"]
    
    if is_ev:
        adjusted_rate += adjustments["ev_vehicle"]
    
    if contract_months >= 48:
        adjusted_rate += adjustments["long_term_48m"]
    
    return max(0.0, adjusted_rate)  # ìŒìˆ˜ ë°©ì§€
```

---

## 4. ì—‘ì…€ â†’ JSON ìë™ ë³€í™˜ ë„êµ¬

### 4.1 ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ ë„êµ¬

**íŒŒì¼: `excel_reverse_engineering/residual_extractor.py`**

```python
"""
excel_reverse_engineering/residual_extractor.py
ì—‘ì…€ì—ì„œ ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ ë° JSON ë³€í™˜
"""

import openpyxl
from typing import Dict, Optional

class ResidualRateExtractor:
    """ì—‘ì…€ì—ì„œ ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ"""
    
    def __init__(self, excel_path: str):
        self.workbook = openpyxl.load_workbook(excel_path, data_only=True)
    
    def extract_all_vehicles(self) -> Dict:
        """
        ëª¨ë“  ì‹œíŠ¸ì—ì„œ ì°¨ëŸ‰ë³„ ì”ì¡´ìœ¨ ì¶”ì¶œ
        
        Returns:
            Dict: {vehicle_id: {24: {10000: 0.65, ...}, ...}, ...}
        """
        all_vehicles = {}
        
        for sheet in self.workbook.worksheets:
            vehicle_id = self._normalize_vehicle_id(sheet.title)
            
            print(f"ì²˜ë¦¬ ì¤‘: {sheet.title} â†’ {vehicle_id}")
            
            residual_table = self._extract_from_sheet(sheet)
            
            if residual_table:
                all_vehicles[vehicle_id] = residual_table
                print(f"  âœ“ ì¶”ì¶œ ì™„ë£Œ: {len(residual_table)}ê°œ ê¸°ê°„")
            else:
                print(f"  âœ— ì”ì¡´ìœ¨ í…Œì´ë¸” ì—†ìŒ")
        
        return all_vehicles
    
    def _normalize_vehicle_id(self, sheet_name: str) -> str:
        """ì‹œíŠ¸ ì´ë¦„ì„ ì°¨ëŸ‰ IDë¡œ ë³€í™˜"""
        # ì˜ˆ: "ê¸°ì•„ K5 2.0 í”„ë ˆìŠ¤í‹°ì§€" â†’ "K5_2024_2.0_PRESTIGE"
        return sheet_name.replace(" ", "_").upper()
    
    def _extract_from_sheet(self, sheet) -> Optional[Dict]:
        """
        ì‹œíŠ¸ì—ì„œ ì”ì¡´ìœ¨ í…Œì´ë¸” ì¶”ì¶œ
        
        ë‘ ê°€ì§€ íŒ¨í„´ ì‹œë„:
        1. ê³„ì•½ê¸°ê°„(ì—´) Ã— ì£¼í–‰ê±°ë¦¬(í–‰)
        2. ì£¼í–‰ê±°ë¦¬(ì—´) Ã— ê³„ì•½ê¸°ê°„(í–‰)
        """
        # íŒ¨í„´ 1 ì‹œë„
        table = self._find_pattern_months_cols(sheet)
        if table:
            return table
        
        # íŒ¨í„´ 2 ì‹œë„
        table = self._find_pattern_mileage_cols(sheet)
        if table:
            return table
        
        return None
    
    def _find_pattern_months_cols(self, sheet) -> Optional[Dict]:
        """
        íŒ¨í„´ 1: ê³„ì•½ê¸°ê°„ì´ ì—´ í—¤ë”, ì£¼í–‰ê±°ë¦¬ê°€ í–‰ í—¤ë”
        
            |  24ê°œì›” | 36ê°œì›” | 48ê°œì›” | 60ê°œì›”
        ----+--------+--------+--------+--------
        10k |  0.65  |  0.53  |  0.43  |  0.33
        15k |  0.63  |  0.51  |  0.41  |  0.31
        20k |  0.62  |  0.50  |  0.40  |  0.30
        30k |  0.59  |  0.47  |  0.37  |  0.27
        """
        period_patterns = [24, 36, 48, 60]
        mileage_patterns = [10000, 15000, 20000, 30000]
        
        for row_idx, row in enumerate(sheet.iter_rows(values_only=True), 1):
            row_values = [cell for cell in row if isinstance(cell, (int, float))]
            
            # ì´ í–‰ì— 24, 36, 48, 60ì´ ëª¨ë‘ ìˆëŠ”ì§€
            if all(period in row_values for period in period_patterns):
                # ê° ê¸°ê°„ì˜ ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
                period_cols = {}
                for col_idx, cell in enumerate(row, 1):
                    if cell in period_patterns:
                        period_cols[cell] = col_idx
                
                # ë‹¤ìŒ í–‰ë“¤ì—ì„œ ì£¼í–‰ê±°ë¦¬ë³„ ì”ì¡´ìœ¨ ì½ê¸°
                residual_data = {}
                
                for next_row_idx in range(row_idx + 1, row_idx + 10):
                    if next_row_idx > sheet.max_row:
                        break
                    
                    next_row = list(sheet.iter_rows(
                        min_row=next_row_idx, 
                        max_row=next_row_idx, 
                        values_only=True
                    ))[0]
                    
                    # ì²« ì—´ì´ ì£¼í–‰ê±°ë¦¬ì¸ì§€ í™•ì¸
                    first_cell = next_row[0]
                    if isinstance(first_cell, (int, float)) and first_cell in mileage_patterns:
                        mileage = int(first_cell)
                        
                        for period, col_idx in period_cols.items():
                            rate = next_row[col_idx - 1]
                            if isinstance(rate, (int, float)) and 0 < rate <= 1:
                                if period not in residual_data:
                                    residual_data[period] = {}
                                residual_data[period][mileage] = float(rate)
                
                if residual_data:
                    return residual_data
        
        return None
    
    def _find_pattern_mileage_cols(self, sheet) -> Optional[Dict]:
        """
        íŒ¨í„´ 2: ì£¼í–‰ê±°ë¦¬ê°€ ì—´ í—¤ë”, ê³„ì•½ê¸°ê°„ì´ í–‰ í—¤ë”
        
            | 10k  | 15k  | 20k  | 30k
        ----+------+------+------+------
        24  | 0.65 | 0.63 | 0.62 | 0.59
        36  | 0.53 | 0.51 | 0.50 | 0.47
        48  | 0.43 | 0.41 | 0.40 | 0.37
        60  | 0.33 | 0.31 | 0.30 | 0.27
        """
        period_patterns = [24, 36, 48, 60]
        mileage_patterns = [10000, 15000, 20000, 30000]
        
        for row_idx, row in enumerate(sheet.iter_rows(values_only=True), 1):
            row_values = [cell for cell in row if isinstance(cell, (int, float))]
            
            # ì´ í–‰ì— ì£¼í–‰ê±°ë¦¬ê°€ ëª¨ë‘ ìˆëŠ”ì§€
            if all(m in row_values for m in mileage_patterns):
                # ê° ì£¼í–‰ê±°ë¦¬ì˜ ì—´ ì¸ë±ìŠ¤
                mileage_cols = {}
                for col_idx, cell in enumerate(row, 1):
                    if cell in mileage_patterns:
                        mileage_cols[int(cell)] = col_idx
                
                # ë‹¤ìŒ í–‰ë“¤ì—ì„œ ê³„ì•½ê¸°ê°„ë³„ ì”ì¡´ìœ¨
                residual_data = {}
                
                for next_row_idx in range(row_idx + 1, row_idx + 10):
                    if next_row_idx > sheet.max_row:
                        break
                    
                    next_row = list(sheet.iter_rows(
                        min_row=next_row_idx, 
                        max_row=next_row_idx, 
                        values_only=True
                    ))[0]
                    
                    first_cell = next_row[0]
                    if isinstance(first_cell, (int, float)) and first_cell in period_patterns:
                        period = int(first_cell)
                        residual_data[period] = {}
                        
                        for mileage, col_idx in mileage_cols.items():
                            rate = next_row[col_idx - 1]
                            if isinstance(rate, (int, float)) and 0 < rate <= 1:
                                residual_data[period][mileage] = float(rate)
                
                if residual_data:
                    return residual_data
        
        return None
```

---

### 4.2 ì—‘ì…€ â†’ JSON ë³€í™˜ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼: `tools/excel_to_json.py`**

```python
"""
tools/excel_to_json.py
ìºí”¼íƒˆì‚¬ ì—‘ì…€ íŒŒì¼ì„ JSONìœ¼ë¡œ ì¼ê´„ ë³€í™˜
"""

import json
from pathlib import Path
import sys

# ìƒìœ„ ë””ë ‰í† ë¦¬ë¥¼ pathì— ì¶”ê°€
sys.path.insert(0, str(Path(__file__).parent.parent))

from excel_reverse_engineering.residual_extractor import ResidualRateExtractor


def convert_excel_to_json(excel_path: str, capital_id: str, 
                          output_dir: str = "data/residual_rates"):
    """
    ì—‘ì…€ íŒŒì¼ì„ JSONìœ¼ë¡œ ë³€í™˜
    
    Parameters:
        excel_path: ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
        capital_id: ìºí”¼íƒˆ ID (ì˜ˆ: "hyundai_capital")
        output_dir: JSON ì €ì¥ ë””ë ‰í† ë¦¬
    """
    print("="*60)
    print(f"ì—‘ì…€ â†’ JSON ë³€í™˜ ì‹œì‘")
    print(f"íŒŒì¼: {excel_path}")
    print(f"ìºí”¼íƒˆ: {capital_id}")
    print("="*60)
    
    # 1. ì—‘ì…€ì—ì„œ ì”ì¡´ìœ¨ ì¶”ì¶œ
    extractor = ResidualRateExtractor(excel_path)
    all_vehicles = extractor.extract_all_vehicles()
    
    print(f"\nì´ {len(all_vehicles)}ëŒ€ ì°¨ëŸ‰ ì¶”ì¶œ ì™„ë£Œ")
    
    # 2. JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (í‚¤ë¥¼ ë¬¸ìì—´ë¡œ)
    json_data = {}
    for vehicle_id, residual_table in all_vehicles.items():
        json_data[vehicle_id] = {
            str(months): {
                str(mileage): rate 
                for mileage, rate in mileage_dict.items()
            }
            for months, mileage_dict in residual_table.items()
        }
    
    # 3. JSON íŒŒì¼ ì €ì¥
    output_path = Path(output_dir) / f"{capital_id}.json"
    output_path.parent.mkdir(parents=True, exist_ok=True)
    
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(json_data, f, indent=2, ensure_ascii=False)
    
    print(f"\nì €ì¥ ì™„ë£Œ: {output_path}")
    print(f"íŒŒì¼ í¬ê¸°: {output_path.stat().st_size / 1024 / 1024:.2f} MB")
    
    # 4. ê²€ì¦
    print("\në°ì´í„° ê²€ì¦ ì¤‘...")
    validate_json_data(output_path)
    
    return output_path


def validate_json_data(json_path: Path):
    """JSON ë°ì´í„° ê²€ì¦"""
    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    total_vehicles = len(data)
    complete_vehicles = 0
    incomplete_vehicles = []
    
    expected_periods = ["24", "36", "48", "60"]
    expected_mileages = ["10000", "15000", "20000", "30000"]
    
    for vehicle_id, residual_table in data.items():
        # ëª¨ë“  ê¸°ê°„ê³¼ ì£¼í–‰ê±°ë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸
        is_complete = True
        
        for period in expected_periods:
            if period not in residual_table:
                is_complete = False
                break
            
            for mileage in expected_mileages:
                if mileage not in residual_table[period]:
                    is_complete = False
                    break
        
        if is_complete:
            complete_vehicles += 1
        else:
            incomplete_vehicles.append(vehicle_id)
    
    print(f"  âœ“ ì „ì²´ ì°¨ëŸ‰: {total_vehicles}ëŒ€")
    print(f"  âœ“ ì™„ì „í•œ ë°ì´í„°: {complete_vehicles}ëŒ€")
    
    if incomplete_vehicles:
        print(f"  âš  ë¶ˆì™„ì „í•œ ë°ì´í„°: {len(incomplete_vehicles)}ëŒ€")
        print(f"     {incomplete_vehicles[:5]}..." if len(incomplete_vehicles) > 5 else f"     {incomplete_vehicles}")


if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description="ì—‘ì…€ ê²¬ì ê¸°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜")
    parser.add_argument("excel_path", help="ì—‘ì…€ íŒŒì¼ ê²½ë¡œ")
    parser.add_argument("capital_id", help="ìºí”¼íƒˆ ID (ì˜ˆ: hyundai_capital)")
    parser.add_argument("--output-dir", default="data/residual_rates", 
                       help="JSON ì €ì¥ ë””ë ‰í† ë¦¬")
    
    args = parser.parse_args()
    
    convert_excel_to_json(
        excel_path=args.excel_path,
        capital_id=args.capital_id,
        output_dir=args.output_dir
    )
    
    print("\nâœ… ë³€í™˜ ì™„ë£Œ!")
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```bash
# í˜„ëŒ€ìºí”¼íƒˆ ì—‘ì…€ íŒŒì¼ ë³€í™˜
python tools/excel_to_json.py "í˜„ëŒ€ìºí”¼íƒˆ_ê²¬ì ê¸°_4000ëŒ€.xlsx" hyundai_capital

# KBìºí”¼íƒˆ ì—‘ì…€ íŒŒì¼ ë³€í™˜
python tools/excel_to_json.py "KBìºí”¼íƒˆ_ê²¬ì ê¸°.xlsx" kb_capital
```

---

## 5. ê³„ì‚° ì—”ì§„ êµ¬í˜„

**íŒŒì¼: `core/calculator.py`**

```python
"""
core/calculator.py
ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚° ì—”ì§„
"""

def calculate_operating_lease(vehicle_price: float, 
                              contract_months: int, 
                              down_payment: float,
                              residual_rate: float, 
                              annual_rate: float,
                              acquisition_tax_rate: float = 0.0, 
                              registration_fee: float = 200_000,
                              annual_car_tax: float = 0.0, 
                              method: str = 'simple') -> dict:
    """
    ìš´ìš©ë¦¬ìŠ¤ ì›” ë¦¬ìŠ¤ë£Œ ê³„ì‚°
    
    Parameters:
        vehicle_price: ì°¨ëŸ‰ê°€
        contract_months: ê³„ì•½ê¸°ê°„ (ê°œì›”)
        down_payment: ì„ ë‚©ê¸ˆ
        residual_rate: ì”ì¡´ìœ¨ (0~1)
        annual_rate: ì—°ì´ìœ¨ (0~1)
        acquisition_tax_rate: ì·¨ë“ì„¸ìœ¨ (0~1)
        registration_fee: ë“±ë¡ë¹„
        annual_car_tax: ì—°ê°„ ìë™ì°¨ì„¸
        method: 'simple' (ì •ì•¡ë²•) or 'annuity' (ì›ë¦¬ê¸ˆê· ë“±)
    
    Returns:
        dict: ê³„ì‚° ê²°ê³¼
    """
    # ê¸ˆìœµ ëŒ€ìƒì•¡
    financed = vehicle_price - down_payment
    residual_value = financed * residual_rate
    depreciation = financed - residual_value
    
    r = annual_rate / 12  # ì›” ê¸ˆë¦¬
    n = contract_months
    
    # ê³„ì‚° ë°©ì‹ ì„ íƒ
    if method == 'annuity':
        # ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜
        if r == 0:
            monthly_depreciation_payment = depreciation / n
        else:
            monthly_depreciation_payment = depreciation * (r / (1 - (1 + r)**-n))
        monthly_rv_interest = residual_value * r
        monthly_base = monthly_depreciation_payment + monthly_rv_interest
        monthly_finance = monthly_base - (depreciation / n)
        
    else:  # 'simple' (ê¸°ë³¸ê°’ - ì •ì•¡ë²•)
        # ì›” ê°ê°€ìƒê°
        monthly_depreciation = depreciation / n
        # í‰ê·  ì”ì•¡
        average_balance = (financed + residual_value) / 2
        # ì›” ê¸ˆìœµë¹„ìš©
        monthly_finance = average_balance * r
        # ì›” ê¸°ë³¸ ë¦¬ìŠ¤ë£Œ
        monthly_base = monthly_depreciation + monthly_finance
    
    # ì„¸ê¸ˆ/ë¹„ìš©
    monthly_tax = (vehicle_price * acquisition_tax_rate) / n
    monthly_registration = registration_fee / n
    monthly_car_tax = annual_car_tax / 12
    
    # ì›” ì´ ë¦¬ìŠ¤ë£Œ
    monthly_total = monthly_base + monthly_tax + monthly_registration + monthly_car_tax
    
    # ì´ ë‚©ë¶€ì•¡ ê³„ì‚°
    total_payment = monthly_total * n + down_payment
    total_interest = monthly_finance * n
    
    return {
        'monthly_total': round(monthly_total, -3),
        'monthly_base': round(monthly_base, -3),
        'monthly_depreciation': round(depreciation / n, -3),
        'monthly_finance': round(monthly_finance, -3),
        'monthly_tax': round(monthly_tax, -3),
        'monthly_registration': round(monthly_registration, -3),
        'monthly_car_tax': round(monthly_car_tax, -3),
        'applied_rate': annual_rate,
        'residual_value': round(residual_value, -3),
        'residual_rate': residual_rate,
        'total_payment': round(total_payment, -3),
        'total_interest': round(total_interest, -3),
        'effective_vehicle_cost': round(total_payment - residual_value, -3),
    }


def calculate_auto_tax(engine_cc: int, is_commercial: bool = True) -> float:
    """
    ìë™ì°¨ì„¸ ê³„ì‚°
    
    Parameters:
        engine_cc: ë°°ê¸°ëŸ‰ (cc)
        is_commercial: ì˜ì—…ìš© ì—¬ë¶€
    
    Returns:
        float: ì—°ê°„ ìë™ì°¨ì„¸
    """
    # ë¹„ì˜ì—…ìš© ê¸°ì¤€ ì„¸ì•¡
    if engine_cc <= 1000:
        base_tax = 80_000 + max(0, (engine_cc - 1000)) * 80 / 1000
    elif engine_cc <= 1600:
        base_tax = 80_000 + (engine_cc - 1000) * 140 / 600
    elif engine_cc <= 2000:
        base_tax = 164_000 + (engine_cc - 1600) * 200 / 400
    else:
        base_tax = 364_000 + (engine_cc - 2000) * 220 / 1000
    
    # ì˜ì—…ìš©ì€ 50% ê°ë©´
    return base_tax * 0.5 if is_commercial else base_tax
```

---

## 6. Streamlit í”„ë¡ íŠ¸ì—”ë“œ

**íŒŒì¼: `app.py`**

```python
"""
app.py
Streamlit ê¸°ë°˜ ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚°ê¸° UI
"""

import streamlit as st
from core.calculator import calculate_operating_lease, calculate_auto_tax
from data.vehicle_master import get_vehicle_list, get_vehicle
from data.residual_rates import get_residual_rate, get_available_capitals
from data.interest_rates import get_interest_rate

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚°ê¸° v2",
    page_icon="ğŸš—",
    layout="wide"
)

st.title("ğŸš— ìš´ìš©ë¦¬ìŠ¤ ê³„ì‚°ê¸° v2")
st.markdown("---")

# ì‚¬ì´ë“œë°”: ì…ë ¥ ì˜ì—­
with st.sidebar:
    st.header("ê³„ì‚° ì¡°ê±´ ì…ë ¥")
    
    # 0. ìºí”¼íƒˆ ì„ íƒ
    st.subheader("0ï¸âƒ£ ìºí”¼íƒˆ ì„ íƒ")
    available_capitals = get_available_capitals()
    
    if not available_capitals:
        st.error("ìºí”¼íƒˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!")
        st.stop()
    
    capital_display = {
        "hyundai_capital": "í˜„ëŒ€ìºí”¼íƒˆ",
        "kb_capital": "KBìºí”¼íƒˆ",
        "lotte_rental": "ë¡¯ë°ì˜¤í† ë¦¬ìŠ¤"
    }
    
    selected_capital = st.selectbox(
        "ìºí”¼íƒˆì„ ì„ íƒí•˜ì„¸ìš”",
        options=available_capitals,
        format_func=lambda x: capital_display.get(x, x)
    )
    
    # 1. ì°¨ëŸ‰ ì„ íƒ
    st.subheader("1ï¸âƒ£ ì°¨ëŸ‰ ì„ íƒ")
    vehicle_list = get_vehicle_list()
    vehicle_options = {v["display"]: v["id"] for v in vehicle_list}
    selected_vehicle_name = st.selectbox(
        "ì°¨ëŸ‰ì„ ì„ íƒí•˜ì„¸ìš”",
        options=list(vehicle_options.keys())
    )
    selected_vehicle_id = vehicle_options[selected_vehicle_name]
    vehicle = get_vehicle(selected_vehicle_id)
    
    st.info(f"ğŸ’° ì°¨ëŸ‰ê°€: {vehicle['price']:,}ì›")
    
    # 2. ê³„ì•½ ê¸°ê°„
    st.subheader("2ï¸âƒ£ ê³„ì•½ ê¸°ê°„")
    contract_months = st.select_slider(
        "ê³„ì•½ ê¸°ê°„ ì„ íƒ",
        options=[24, 36, 48, 60],
        value=36,
        format_func=lambda x: f"{x}ê°œì›”"
    )
    
    # 3. ì—°ê°„ ì£¼í–‰ê±°ë¦¬
    st.subheader("3ï¸âƒ£ ì—°ê°„ ì£¼í–‰ê±°ë¦¬")
    annual_mileage = st.select_slider(
        "ì—°ê°„ ì£¼í–‰ê±°ë¦¬ ì„ íƒ",
        options=[10000, 15000, 20000, 30000],
        value=20000,
        format_func=lambda x: f"{x:,}km"
    )
    
    # 4. ì„ ë‚©ê¸ˆ
    st.subheader("4ï¸âƒ£ ì„ ë‚©ê¸ˆ")
    max_down = vehicle['price'] * 0.3
    down_payment = st.slider(
        "ì„ ë‚©ê¸ˆ (ì°¨ëŸ‰ê°€ì˜ 0~30%)",
        min_value=0,
        max_value=int(max_down),
        value=0,
        step=1_000_000
    )
    
    st.markdown("---")
    calculate_button = st.button("ğŸ’¡ ê³„ì‚°í•˜ê¸°", type="primary", use_container_width=True)

# ë©”ì¸ ì˜ì—­: ê²°ê³¼ í‘œì‹œ
if calculate_button:
    with st.spinner("ê³„ì‚° ì¤‘..."):
        try:
            # íŒŒë¼ë¯¸í„° ì¡°íšŒ
            residual_rate = get_residual_rate(
                capital_id=selected_capital,
                vehicle_id=selected_vehicle_id,
                contract_months=contract_months,
                annual_mileage=annual_mileage
            )
            
            annual_rate = get_interest_rate(
                capital_id=selected_capital,
                vehicle_price=vehicle['price'],
                is_import=vehicle['is_import'],
                is_ev=vehicle['is_ev'],
                contract_months=contract_months
            )
            
            annual_car_tax = calculate_auto_tax(
                engine_cc=vehicle['engine_cc'],
                is_commercial=True
            )
            
            # ê³„ì‚° ì‹¤í–‰
            result = calculate_operating_lease(
                vehicle_price=vehicle['price'],
                contract_months=contract_months,
                down_payment=down_payment,
                residual_rate=residual_rate,
                annual_rate=annual_rate,
                acquisition_tax_rate=0.0,  # ì˜ì—…ìš© ë©´ì œ
                registration_fee=200_000,
                annual_car_tax=annual_car_tax,
                method='simple'
            )
        
        except ValueError as e:
            st.error(f"âŒ ì˜¤ë¥˜: {str(e)}")
            st.stop()
    
    # ê²°ê³¼ í‘œì‹œ
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            label="ğŸ’° ì›” ë¦¬ìŠ¤ë£Œ",
            value=f"{result['monthly_total']:,}ì›"
        )
    
    with col2:
        st.metric(
            label="ğŸ“Š ì”ì¡´ê°€ì¹˜",
            value=f"{result['residual_value']:,}ì›",
            delta=f"{residual_rate:.1%}"
        )
    
    with col3:
        st.metric(
            label="ğŸ“ˆ ì ìš© ê¸ˆë¦¬",
            value=f"{result['applied_rate']:.2%}"
        )
    
    st.markdown("---")
    
    # ìƒì„¸ ë‚´ì—­
    st.subheader("ğŸ“‹ ì›” ë¦¬ìŠ¤ë£Œ ìƒì„¸ ë‚´ì—­")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**ë¹„ìš© êµ¬ì„±**")
        breakdown_data = {
            "í•­ëª©": ["ê°ê°€ìƒê°ë¹„", "ê¸ˆìœµë¹„ìš©", "ë“±ë¡ë¹„", "ìë™ì°¨ì„¸"],
            "ê¸ˆì•¡": [
                f"{result['monthly_depreciation']:,}ì›",
                f"{result['monthly_finance']:,}ì›",
                f"{result['monthly_registration']:,}ì›",
                f"{result['monthly_car_tax']:,}ì›",
            ]
        }
        st.table(breakdown_data)
    
    with col2:
        st.markdown("**ì´ ë¹„ìš© ìš”ì•½**")
        summary_data = {
            "í•­ëª©": ["ì´ ë‚©ë¶€ì•¡", "ì´ ì´ì", "ì‹¤ì°¨ëŸ‰ë¹„ìš©"],
            "ê¸ˆì•¡": [
                f"{result['total_payment']:,}ì›",
                f"{result['total_interest']:,}ì›",
                f"{result['effective_vehicle_cost']:,}ì›",
            ]
        }
        st.table(summary_data)
    
    # ì°¸ê³ ì‚¬í•­
    st.markdown("---")
    st.info(f"""
    â„¹ï¸ **ì°¸ê³ ì‚¬í•­**
    - ìºí”¼íƒˆ: {capital_display.get(selected_capital, selected_capital)}
    - ë³¸ ê³„ì‚°ê¸°ëŠ” ì˜ì—…ìš© ë“±ë¡ ê¸°ì¤€ì…ë‹ˆë‹¤ (ì·¨ë“ì„¸ ë©´ì œ)
    - ë³´í—˜ë£ŒëŠ” ë³„ë„ì´ë©°, ê³ ê°ë‹˜ê»˜ì„œ ì§ì ‘ ê°€ì…í•˜ì…”ì•¼ í•©ë‹ˆë‹¤
    - ì‹¤ì œ ë¦¬ìŠ¤ë£ŒëŠ” ì‹ ìš©ë„, í”„ë¡œëª¨ì…˜ ë“±ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
    """)
    
    # ê°œë°œì ë„êµ¬ (ê²€ì¦ìš©)
    with st.expander("ğŸ” ê°œë°œì ë„êµ¬ (ê²€ì¦)"):
        st.json(result)

else:
    st.info("ğŸ‘ˆ ì™¼ìª½ì—ì„œ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  'ê³„ì‚°í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”")
    
    # ë°ì´í„° í†µê³„ í‘œì‹œ
    st.markdown("---")
    st.subheader("ğŸ“Š ë°ì´í„° í˜„í™©")
    
    col1, col2 = st.columns(2)
    
    with col1:
        vehicle_count = len(get_vehicle_list())
        st.metric("ë“±ë¡ëœ ì°¨ëŸ‰ ìˆ˜", f"{vehicle_count:,}ëŒ€")
    
    with col2:
        capital_count = len(get_available_capitals())
        st.metric("ë“±ë¡ëœ ìºí”¼íƒˆ ìˆ˜", f"{capital_count}ê°œ")
```

---

## 7. ì‹¤í–‰ ê³„íš

### Phase 1: ì—‘ì…€ ì—­ê³µí•™ ë° ë°ì´í„° êµ¬ì¶•

**Week 1: ì—‘ì…€ ë¶„ì„**
- [ ] ê¸ˆìœµì‚¬ ì—‘ì…€ íŒŒì¼ í™•ë³´
- [ ] ì—‘ì…€ êµ¬ì¡° ë¶„ì„ (ì‹œíŠ¸, ì…€, ìˆ˜ì‹)
- [ ] ì”ì¡´ìœ¨ í…Œì´ë¸” ìœ„ì¹˜ ì‹ë³„
- [ ] ResidualRateExtractor ê°œë°œ ë° í…ŒìŠ¤íŠ¸

**Week 2: JSON ë°ì´í„° êµ¬ì¶•**
- [ ] ì—‘ì…€ â†’ JSON ë³€í™˜ ë„êµ¬ ê°œë°œ
- [ ] ì „ì²´ ì°¨ëŸ‰(3,000~4,000ëŒ€) ë°ì´í„° ë³€í™˜
- [ ] ë°ì´í„° ê²€ì¦ ë° ë³´ì™„
- [ ] vehicle_master.json êµ¬ì¶•

### Phase 2: ê³„ì‚°ê¸° ê°œë°œ

**Day 1-2: Core Engine**
- [ ] calculate_operating_lease() êµ¬í˜„
- [ ] calculate_auto_tax() êµ¬í˜„
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±

**Day 3-4: Data Layer**
- [ ] JSON ë¡œë” êµ¬í˜„
- [ ] residual_rates.py
- [ ] interest_rates.py
- [ ] vehicle_master.py

**Day 5: ê²€ì¦**
- [ ] ì—‘ì…€ê³¼ ë¹„êµ í…ŒìŠ¤íŠ¸ (10ê°œ ì¼€ì´ìŠ¤)
- [ ] ì˜¤ì°¨ ë¶„ì„ ë° ì¡°ì •

### Phase 3: UI ê°œë°œ

**Day 1-3: Streamlit ì•±**
- [ ] ê¸°ë³¸ UI êµ¬í˜„
- [ ] ìºí”¼íƒˆ/ì°¨ëŸ‰ ì„ íƒ ê¸°ëŠ¥
- [ ] ê³„ì‚° ê²°ê³¼ í‘œì‹œ

**Day 4-5: UX ê°œì„ **
- [ ] ìƒì„¸ ë‚´ì—­ í‘œì‹œ
- [ ] ì°¨ëŸ‰ ê²€ìƒ‰/í•„í„° ê¸°ëŠ¥
- [ ] ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ

### Phase 4: ë°°í¬

- [ ] ë¬¸ì„œí™” (README, ì‚¬ìš© ê°€ì´ë“œ)
- [ ] ë°°í¬ í™˜ê²½ ì„¤ì •
- [ ] ìµœì¢… í…ŒìŠ¤íŠ¸

---

## 8. í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

```txt
# requirements.txt

# í•µì‹¬
streamlit==1.31.0
openpyxl==3.1.2

# ê³„ì‚°/ë¶„ì„
numpy==1.26.3
pandas==2.2.0
scipy==1.12.0

# í…ŒìŠ¤íŠ¸
pytest==8.0.0
pytest-cov==4.1.0

# ìœ í‹¸
python-dateutil==2.8.2
```

---

## 9. ë°ì´í„° ê´€ë¦¬ ê°€ì´ë“œ

### JSON íŒŒì¼ ì—…ë°ì´íŠ¸ í”„ë¡œì„¸ìŠ¤

1. **ê¸ˆìœµì‚¬ì—ì„œ ìƒˆ ì—‘ì…€ íŒŒì¼ ìˆ˜ë ¹**
2. **ë³€í™˜ ë„êµ¬ ì‹¤í–‰**
   ```bash
   python tools/excel_to_json.py "ìƒˆê²¬ì ê¸°.xlsx" hyundai_capital
   ```
3. **ê²€ì¦**
   ```bash
   python tools/validate_json.py data/residual_rates/hyundai_capital.json
   ```
4. **ê¸°ì¡´ íŒŒì¼ ë°±ì—… í›„ êµì²´**
5. **Streamlit ì•± ì¬ì‹œì‘** (ìë™ ë¦¬ë¡œë“œ)

### ì°¨ëŸ‰ ì¶”ê°€ í”„ë¡œì„¸ìŠ¤

1. **vehicle_master.json ìˆ˜ì •**
   - ìƒˆ ì°¨ëŸ‰ ì •ë³´ ì¶”ê°€
2. **ì”ì¡´ìœ¨ JSONì— í•´ë‹¹ ì°¨ëŸ‰ ë°ì´í„° ì¶”ê°€**
3. **ê²€ì¦ í›„ ë°°í¬**

---

## 10. ì£¼ì˜ì‚¬í•­

### ë°ì´í„° ë¬´ê²°ì„±
- ìˆ˜ì • ì‹œ í•­ìƒ ë°±ì—… ë¨¼ì €
- ìºí”¼íƒˆë³„ë¡œ ì°¨ëŸ‰ ID í†µì¼ í•„ìˆ˜




